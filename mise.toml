# Zentinel - mise configuration
# Production-grade reverse proxy built on Pingora

[env]
RUST_BACKTRACE = "1"
CARGO_TERM_COLOR = "always"
RUST_LOG = "info"
ZENTINEL_CONFIG = "config/zentinel.kdl"
ZENTINEL_WORKERS = "0"

[tools]
rust = "1.92.0"
# These cargo tools are not recognized by mise yet, commenting out to avoid warnings
# cargo-audit = "latest"
# cargo-tarpaulin = "latest"
# cargo-watch = "latest"
# cargo-machete = "latest"
# cargo-flamegraph = "latest"

# Build tasks
[tasks.build]
description = "Build debug binary"
run = "cargo build --workspace"

[tasks.release]
description = "Build optimized release binary"
run = """
cargo build --release --workspace
strip target/release/zentinel 2>/dev/null || true
strip target/release/zentinel-echo-agent 2>/dev/null || true
echo "Release build complete"
"""

[tasks.install]
description = "Build and install release binaries"
depends = ["release"]
run = """
sudo cp target/release/zentinel /usr/local/bin/
sudo cp target/release/zentinel-echo-agent /usr/local/bin/ 2>/dev/null || true
echo "Installation complete"
"""

# Test tasks
[tasks.test]
description = "Run all tests"
run = "cargo test --workspace --all-features -- --nocapture"

[tasks.test-unit]
description = "Run unit tests only"
run = "cargo test --workspace --lib"

[tasks.test-integration]
description = "Run integration tests"
run = """
cargo test --workspace --test '*'
./tests/test_agents.sh
"""

[tasks.test-coverage]
description = "Generate test coverage report"
run = """
cargo tarpaulin --workspace --all-features --out html --output-dir target/coverage
echo "Coverage report generated: target/coverage/tarpaulin-report.html"
"""

[tasks.bench]
description = "Run benchmarks"
run = "cargo bench --workspace --no-fail-fast"

# Code quality tasks
[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.fmt-check]
description = "Check code formatting"
run = "cargo fmt --all -- --check"

[tasks.lint]
description = "Run clippy linter"
run = "cargo clippy --workspace --all-targets --all-features -- -D warnings"

[tasks.audit]
description = "Run security audit"
run = "cargo audit"

[tasks.docs-check]
description = "Check documentation builds without warnings"
run = "RUSTDOCFLAGS='-D warnings' cargo doc --workspace --no-deps"

[tasks.pre-push]
description = "Fast CI checks before pushing (saves GHA minutes)"
depends = ["fmt-check", "lint", "docs-check"]
run = "echo 'Pre-push checks passed â€” safe to push!'"

[tasks.check]
description = "Run fmt, lint, and test"
depends = ["fmt", "lint", "test"]

[tasks.unused-deps]
description = "Check for unused dependencies"
run = "cargo machete"

# Development tasks
[tasks.run]
description = "Run proxy with debug build"
depends = ["build"]
run = "RUST_LOG=${RUST_LOG:-debug} ./target/debug/zentinel"

[tasks.run-release]
description = "Run proxy with release build"
depends = ["release"]
run = "./target/release/zentinel"

[tasks.watch]
description = "Watch for changes and rebuild"
run = "cargo watch -x build -x test"

[tasks.dev]
description = "Run development environment with echo agent"
run = """
#!/bin/bash
set -e

# Build everything first
mise run build

# Start echo agent in background
echo "Starting echo agent..."
./target/debug/zentinel-echo-agent --socket /tmp/zentinel-echo.sock &
ECHO_PID=$!

# Trap to cleanup on exit
trap "kill $ECHO_PID 2>/dev/null || true" EXIT INT TERM

# Start proxy in foreground
echo "Starting proxy..."
RUST_LOG=debug ./target/debug/zentinel
"""

# Agent tasks
[tasks.agent-echo]
description = "Run echo agent"
depends = ["build"]
run = "./target/debug/zentinel-echo-agent --socket /tmp/echo.sock --verbose"

[tasks.agent-test]
description = "Test agent communication"
depends = ["build"]
run = "./tests/test_agents.sh"

# Documentation tasks
[tasks.docs]
description = "Generate and open documentation"
run = "cargo doc --workspace --all-features --no-deps --open"

[tasks.docs-serve]
description = "Serve documentation locally"
run = """
cargo doc --workspace --all-features --no-deps
cd target/doc && python3 -m http.server 8000
"""

# Clean tasks
[tasks.clean]
description = "Clean build artifacts"
run = """
cargo clean
rm -rf target/coverage
rm -f /tmp/zentinel*.sock
echo "Clean complete"
"""

[tasks.clean-all]
description = "Deep clean including installed binaries"
depends = ["clean"]
run = """
sudo rm -f /usr/local/bin/zentinel
sudo rm -f /usr/local/bin/zentinel-echo-agent
echo "Deep clean complete"
"""

# Deployment tasks
[tasks.deploy]
description = "Deploy to production"
depends = ["release", "test"]
run = "./deploy/deploy.sh install"

[tasks.upgrade]
description = "Upgrade existing installation"
depends = ["release", "test"]
run = "./deploy/deploy.sh upgrade"

[tasks.rollback]
description = "Rollback to previous version"
run = "./deploy/deploy.sh rollback"

[tasks.systemd-install]
description = "Install systemd services"
run = """
sudo cp deploy/*.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable zentinel.service
echo "Systemd services installed"
"""

[tasks.systemd-start]
description = "Start all services"
run = """
sudo systemctl start zentinel.service
sudo systemctl start zentinel-echo-agent.service || true
"""

[tasks.systemd-stop]
description = "Stop all services"
run = """
sudo systemctl stop zentinel-echo-agent.service || true
sudo systemctl stop zentinel.service
"""

[tasks.systemd-status]
description = "Show service status"
run = """
systemctl status zentinel.service --no-pager || true
echo ""
systemctl status zentinel-echo-agent.service --no-pager || true
"""

# Configuration tasks
[tasks.config-validate]
description = "Validate configuration"
run = "./target/release/zentinel --validate --config ${ZENTINEL_CONFIG}"

[tasks.config-reload]
description = "Reload configuration (hot reload)"
run = "sudo kill -HUP $(cat /var/run/zentinel.pid)"

[tasks.config-example]
description = "Generate example configuration"
run = """
cat > config/example.kdl << 'EOF'
// Example Zentinel Configuration
system {
    worker-threads 4
    max-connections 10000
}

listeners {
    listener "http" {
        address "0.0.0.0:8080"
        protocol "http"
    }
}

routes {
    route "default" {
        matches { path-prefix "/" }
        upstream "backend"
        agents ["echo-agent"]
    }
}

upstreams {
    upstream "backend" {
        targets {
            target { address "127.0.0.1:8081" weight 1 }
        }
        load-balancing "round_robin"
    }
}

agents {
    agent "echo-agent" {
        type "custom"
        transport "unix_socket" { path "/tmp/echo.sock" }
        events ["request_headers"]
        timeout-ms 100
        failure-mode "open"
    }
}
EOF
echo "Example configuration created: config/example.kdl"
"""

# Performance tasks
[tasks.profile]
description = "Run with profiling"
depends = ["release"]
run = """
RUST_LOG=debug perf record -g ./target/release/zentinel
perf report
"""

[tasks.flamegraph]
description = "Generate flamegraph"
run = """
cargo flamegraph --bin zentinel -- --help
echo "Flamegraph saved to flamegraph.svg"
"""

[tasks.load-test]
description = "Run load test"
run = """
echo "Ensure proxy is running first!"
echo "Using k6 for load testing..."
k6 run tests/load/basic.js || echo "Install k6 from https://k6.io"
"""

# Utility tasks
[tasks.version]
description = "Show version information"
run = """
echo "Zentinel Version Information:"
echo "=============================="
./target/release/zentinel --version 2>/dev/null || echo "Not built yet"
echo ""
echo "Git commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
echo "Build time: $(date)"
"""

[tasks.stats]
description = "Show project statistics"
run = """
echo "Project Statistics:"
echo "=================="
echo "Lines of Rust code:"
find crates agents -name "*.rs" | xargs wc -l | tail -1
echo ""
echo "Dependencies:"
cargo tree | head -20
echo ""
echo "Binary sizes (if built):"
ls -lh target/release/zentinel 2>/dev/null || echo "Not built yet"
ls -lh target/release/zentinel-echo-agent 2>/dev/null || echo "Not built yet"
"""

[tasks.ci]
description = "Run CI checks locally"
depends = ["fmt-check", "lint", "test", "audit"]
run = "echo 'All CI checks passed!'"

[tasks.setup]
description = "Set up development environment"
run = """
echo "Setting up Zentinel development environment..."
rustup component add rustfmt clippy
cargo install cargo-audit cargo-tarpaulin cargo-watch cargo-machete cargo-flamegraph
echo "Creating directories..."
mkdir -p config logs tests/load
echo "Development environment ready!"
echo ""
echo "Quick start:"
echo "  mise run build      # Build the project"
echo "  mise run dev        # Run development environment"
echo "  mise run test       # Run tests"
echo "  mise run check      # Run all checks"
"""

[tasks.all]
description = "Build everything and run all tests"
depends = ["fmt", "lint", "build", "test", "audit"]
run = "echo 'Full build and test completed successfully!'"

# Quick aliases
[tasks.b]
alias = "build"

[tasks.r]
alias = "run"

[tasks.t]
alias = "test"

[tasks.c]
alias = "check"

# Default task
[tasks.default]
description = "Show available tasks"
run = "mise tasks"
