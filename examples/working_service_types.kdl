// Working Zentinel Configuration with Service Types
// This configuration demonstrates the actual working functionality

system {
    worker_threads 4
    max_connections 10000
    graceful_shutdown_timeout_secs 30
}

listeners {
    listener "main" {
        address "0.0.0.0:8080"
        protocol "http"
        request_timeout_secs 30
        keepalive_timeout_secs 60
    }
}

routes {
    // Static file serving for assets
    route "static-assets" {
        id "static-assets"
        priority 100
        service_type "static"

        matches {
            path_prefix "/assets"
        }

        // No upstream needed for static files
        upstream null

        static_files {
            root "/var/www/static/assets"
            index "index.html"
            directory_listing false
            cache_control "public, max-age=31536000, immutable"
            compress true

            mime_types {
                "wasm" "application/wasm"
                "mjs" "application/javascript"
            }
        }

        error_pages {
            default_format "html"
            pages {
                404 {
                    format "html"
                    message "The file you're looking for doesn't exist"
                }
            }
        }
    }

    // SPA application with fallback
    route "spa-app" {
        id "spa-app"
        priority 90
        service_type "static"

        matches {
            host "app.example.com"
            path_prefix "/"
        }

        upstream null

        static_files {
            root "/var/www/spa-app/dist"
            index "index.html"
            directory_listing false
            cache_control "public, max-age=3600"
            compress true

            // Important: fallback for client-side routing
            fallback "index.html"
        }
    }

    // API route with JSON validation
    route "api-users" {
        id "api-users"
        priority 95
        service_type "api"

        matches {
            path_prefix "/api/users"
        }

        upstream "api-backend"

        // JSON Schema validation
        api_schema {
            validate_requests true
            validate_responses false
            strict_mode false

            request_schema {
                type "object"
                properties {
                    username {
                        type "string"
                        minLength 3
                        maxLength 30
                        pattern "^[a-zA-Z0-9_]+$"
                    }
                    email {
                        type "string"
                        format "email"
                    }
                    password {
                        type "string"
                        minLength 8
                    }
                    age {
                        type "integer"
                        minimum 13
                        maximum 120
                    }
                }
                required ["username", "email", "password"]
                additionalProperties false
            }
        }

        // JSON error responses for API
        error_pages {
            default_format "json"

            pages {
                400 {
                    format "json"
                    message "Invalid request data"
                    headers {
                        "X-Error-Code" "VALIDATION_ERROR"
                    }
                }
                401 {
                    format "json"
                    message "Authentication required"
                    headers {
                        "WWW-Authenticate" "Bearer"
                    }
                }
                404 {
                    format "json"
                    message "User not found"
                }
                500 {
                    format "json"
                    message "Internal server error"
                }
            }
        }

        policies {
            timeout_secs 10
            max_body_size "1MB"
        }
    }

    // Traditional web application
    route "web-app" {
        id "web-app"
        priority 80
        service_type "web"

        matches {
            host "www.example.com"
            path_prefix "/"
        }

        upstream "web-backend"

        // HTML error pages for web routes
        error_pages {
            default_format "html"
            template_dir "/etc/zentinel/error-templates"

            pages {
                404 {
                    format "html"
                    template "404.html"
                    message "Page not found"
                }
                500 {
                    format "html"
                    template "500.html"
                    message "Something went wrong"
                }
                502 {
                    format "html"
                    message "The service is temporarily unavailable"
                }
                503 {
                    format "html"
                    message "Service maintenance in progress"
                }
            }
        }

        policies {
            timeout_secs 30
            max_body_size "10MB"
            buffer_responses true

            response_headers {
                set {
                    "X-Frame-Options" "SAMEORIGIN"
                    "X-Content-Type-Options" "nosniff"
                }
            }
        }
    }

    // Health check endpoint (simple API)
    route "health" {
        id "health"
        priority 99
        service_type "api"

        matches {
            path "/health"
        }

        upstream "health-backend"

        error_pages {
            default_format "json"
            pages {
                503 {
                    format "json"
                    message "Service unhealthy"
                    headers {
                        "Retry-After" "60"
                    }
                }
            }
        }

        policies {
            timeout_secs 5
            failure_mode "closed"
        }
    }

    // GraphQL API with different validation
    route "graphql" {
        id "graphql"
        priority 85
        service_type "api"

        matches {
            path "/graphql"
        }

        upstream "graphql-backend"

        api_schema {
            validate_requests true

            request_schema {
                type "object"
                properties {
                    query {
                        type "string"
                        minLength 1
                    }
                    variables {
                        type "object"
                    }
                    operationName {
                        type "string"
                    }
                }
                required ["query"]
            }
        }

        error_pages {
            default_format "json"
        }

        policies {
            timeout_secs 30
            max_body_size "5MB"
        }
    }

    // Documentation site with directory listing
    route "docs" {
        id "docs"
        priority 70
        service_type "static"

        matches {
            host "docs.example.com"
        }

        upstream null

        static_files {
            root "/var/www/docs"
            index "index.html"
            directory_listing true  // Allow browsing
            cache_control "public, max-age=7200"
            compress true
        }
    }
}

// Upstream configurations
upstreams {
    upstream "web-backend" {
        id "web-backend"

        targets [
            { address "10.0.1.10:3000" weight 1 }
            { address "10.0.1.11:3000" weight 1 }
        ]

        health_check {
            check_type { http { path "/health" expected_status 200 } }
            interval_secs 10
            timeout_secs 3
            healthy_threshold 2
            unhealthy_threshold 3
        }

        connection_pool {
            max_connections 100
            max_idle 50
            idle_timeout_secs 60
        }
    }

    upstream "api-backend" {
        id "api-backend"

        targets [
            { address "10.0.2.10:8080" weight 1 }
            { address "10.0.2.11:8080" weight 1 }
            { address "10.0.2.12:8080" weight 2 }
        ]

        health_check {
            check_type { http { path "/api/health" expected_status 200 } }
            interval_secs 5
            timeout_secs 2
        }
    }

    upstream "graphql-backend" {
        id "graphql-backend"

        targets [
            { address "10.0.3.10:4000" weight 1 }
        ]
    }

    upstream "health-backend" {
        id "health-backend"

        targets [
            { address "127.0.0.1:9090" weight 1 }
        ]
    }
}

// Limits configuration
limits {
    max_header_count 100
    max_header_size_bytes 16384
    max_body_size_bytes 10485760  // 10MB default
    max_uri_length 8192
    max_connections 10000
}

// Observability
observability {
    metrics {
        enabled true
        address "0.0.0.0:9090"
        path "/metrics"
        high_cardinality false
    }

    logging {
        level "info"
        format "json"
        timestamps true

        access_log {
            enabled true
            file "/var/log/zentinel/access.log"
            format "json"
            buffer_size 8192
        }
    }
}

// WAF configuration (disabled for static routes)
waf {
    engine "modsecurity"
    mode "detection"

    ruleset {
        crs_version "4.0.0"
        paranoia_level 1
        anomaly_threshold 5

        // Exclude JSON validation rules for API routes
        exclusions [
            {
                rule_ids [920420, 920320]
                scope { path "/api" }
            }
        ]
    }

    body_inspection {
        inspect_request_body true
        inspect_response_body false
        max_inspection_bytes 131072

        content_types [
            "application/x-www-form-urlencoded"
            "multipart/form-data"
            "application/json"
            "application/xml"
            "text/xml"
        ]
    }
}
