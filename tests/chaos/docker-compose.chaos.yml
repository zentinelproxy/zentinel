#
# Zentinel Chaos Test Environment
#
# This compose file creates an isolated environment for chaos testing.
# Services can be killed, paused, and restarted to test resilience.
#
# Usage:
#   docker compose -p chaos -f docker-compose.chaos.yml up -d
#   docker compose -p chaos -f docker-compose.chaos.yml down
#

services:
  # Main proxy service under test
  proxy:
    build:
      context: ../..
      target: proxy
    container_name: chaos-proxy
    ports:
      - "18080:8080"   # HTTP (using 18080 to avoid conflicts)
    volumes:
      - ./chaos-config.kdl:/etc/zentinel/config.kdl:ro
      - chaos-agent-sockets:/var/run/zentinel
    environment:
      RUST_LOG: info,zentinel_proxy=debug
      ZENTINEL_CONFIG: /etc/zentinel/config.kdl
    networks:
      - chaos-net
    depends_on:
      backend-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: "no"  # Don't auto-restart during chaos tests

  # Echo agent for testing agent failures
  echo:
    build:
      context: ../..
      target: echo-agent
    container_name: chaos-echo
    volumes:
      - chaos-agent-sockets:/var/run/zentinel
    environment:
      RUST_LOG: info,zentinel_echo_agent=debug
      ECHO_AGENT_SOCKET: /var/run/zentinel/echo.sock
    networks:
      - chaos-net
    restart: "no"  # Don't auto-restart during chaos tests

  # Primary backend (nginx - lightweight, multi-arch)
  backend-primary:
    image: nginx:alpine
    container_name: chaos-backend-primary
    networks:
      - chaos-net
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: "no"

  # Secondary backend for failover testing
  backend-secondary:
    image: nginx:alpine
    container_name: chaos-backend-secondary
    networks:
      - chaos-net
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: "no"

  # Slow backend for timeout testing
  backend-slow:
    image: nginx:alpine
    container_name: chaos-backend-slow
    networks:
      - chaos-net
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: "no"
    # NET_ADMIN capability for network chaos injection (optional)
    cap_add:
      - NET_ADMIN

volumes:
  chaos-agent-sockets:
    driver: local

networks:
  chaos-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
