<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zentinel Playground WASM Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d9ff; }
        h2 { color: #ff6b6b; margin-top: 30px; }
        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            background: #0f0f23;
            color: #ccc;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            resize: vertical;
        }
        button {
            background: #00d9ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }
        button:hover { background: #00b8d9; }
        pre {
            background: #0f0f23;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading { background: #1e3a5f; }
        .status.ready { background: #166534; }
        .status.failed { background: #991b1b; }
        .tab-bar {
            margin-bottom: 10px;
        }
        .tab {
            background: #1e3a5f;
            color: #aaa;
            font-weight: normal;
        }
        .tab:hover { background: #2a4a6f; color: #eee; }
        .tab.active { background: #00d9ff; color: #000; font-weight: bold; }
        .warn-badge { color: #fbbf24; }
        .err-badge { color: #f87171; }
        .info-badge { color: #60a5fa; }
    </style>
</head>
<body>
    <h1>Zentinel Playground WASM Test</h1>

    <div id="status" class="status loading">Loading WASM module...</div>

    <h2>1. Validate Configuration</h2>
    <div class="section">
        <textarea id="config">// Zentinel Basic Configuration Example
system {
    worker-threads 0
    max-connections 10000
    graceful-shutdown-timeout-secs 30
}

listeners {
    listener "http" {
        address "0.0.0.0:8080"
        protocol "http"
        request-timeout-secs 60
    }
}

routes {
    route "api" {
        priority "high"
        matches {
            path-prefix "/api"
        }
        upstream "backend"
        policies {
            timeout-secs 30
            failure-mode "open"
        }
    }
    route "static" {
        priority "normal"
        matches {
            path-prefix "/static"
        }
        upstream "backend"
    }
    route "default" {
        priority "low"
        matches {
            path-prefix "/"
        }
        upstream "backend"
    }
}

upstreams {
    upstream "backend" {
        target "127.0.0.1:8081" weight=1
        target "127.0.0.1:8082" weight=2

        load-balancing "round_robin"

        health-check {
            type "http" {
                path "/health"
                expected-status 200
            }
            interval-secs 10
            timeout-secs 5
            healthy-threshold 2
            unhealthy-threshold 3
        }
    }
}

limits {
    max-header-size-bytes 8192
    max-header-count 100
    max-body-size-bytes 10485760
}</textarea>
        <br>
        <button onclick="runValidate()">Validate Config</button>
        <pre id="validate-result">Click "Validate Config" to test</pre>
    </div>

    <h2>2. Simulate Request</h2>
    <div class="section">
        <p>
            <label>Method: <select id="method">
                <option>GET</option>
                <option>POST</option>
                <option>PUT</option>
                <option>DELETE</option>
            </select></label>
            <label>Host: <input type="text" id="host" value="example.com" style="width: 150px"></label>
            <label>Path: <input type="text" id="path" value="/api/users" style="width: 200px"></label>
        </p>
        <button onclick="runSimulate()">Simulate Request</button>
        <button onclick="runSimulateNoMatch()">Simulate /unknown (no match)</button>
        <pre id="simulate-result">Click "Simulate Request" to test</pre>
    </div>

    <h2>3. Get Normalized Config</h2>
    <div class="section">
        <button onclick="runNormalized()">Get Normalized Config</button>
        <pre id="normalized-result">Click to see config with defaults applied</pre>
    </div>

    <h2>4. Topology Inspector</h2>
    <div class="section">
        <div class="tab-bar">
            <button class="tab active" onclick="switchTopologyTab('text', this)">Text</button>
            <button class="tab" onclick="switchTopologyTab('mermaid', this)">Mermaid</button>
            <button class="tab" onclick="switchTopologyTab('dot', this)">DOT</button>
            <button class="tab" onclick="switchTopologyTab('json', this)">JSON</button>
            <button class="tab" onclick="switchTopologyTab('graph', this)">Graph (raw)</button>
            <span style="margin-left: 20px;"></span>
            <button onclick="runLint()">Lint Only</button>
        </div>
        <div id="mermaid-container" style="display: none;">
            <div id="mermaid-diagram" style="background: #fff; border-radius: 4px; padding: 20px; overflow-x: auto; min-height: 100px;"></div>
            <details style="margin-top: 8px;">
                <summary style="cursor: pointer; color: #888; font-size: 12px;">Show source</summary>
                <pre id="mermaid-source" style="margin-top: 4px;"></pre>
            </details>
        </div>
        <pre id="topology-result">Select a format and the topology will render from the config above</pre>
    </div>

    <h2>5. Module Info</h2>
    <div class="section">
        <pre id="info">Loading...</pre>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });

        let mermaidRenderCounter = 0;

        async function renderMermaidDiagram(source) {
            const container = document.getElementById('mermaid-diagram');
            try {
                const id = `mermaid-svg-${++mermaidRenderCounter}`;
                const { svg } = await mermaid.render(id, source);
                container.innerHTML = svg;
            } catch (e) {
                container.innerHTML = `<pre style="color: #f87171; background: none;">Mermaid render error: ${e.message}</pre>`;
            }
        }

        import init, {
            validate,
            simulate,
            get_normalized_config,
            create_sample_request,
            get_version,
            init_panic_hook,
            inspect_topology,
            render_topology,
            lint_config
        } from './pkg/zentinel_playground_wasm.js';

        let wasmReady = false;

        async function initWasm() {
            try {
                await init();
                init_panic_hook();
                wasmReady = true;

                document.getElementById('status').className = 'status ready';
                document.getElementById('status').textContent = '✓ WASM module loaded successfully!';

                // Show module info
                const version = get_version();
                document.getElementById('info').textContent = `Version: ${version}\nStatus: Ready`;

                // Make functions globally available
                window.runValidate = runValidate;
                window.runSimulate = runSimulate;
                window.runSimulateNoMatch = runSimulateNoMatch;
                window.runNormalized = runNormalized;
                window.switchTopologyTab = switchTopologyTab;
                window.runLint = runLint;

            } catch (e) {
                document.getElementById('status').className = 'status failed';
                document.getElementById('status').textContent = '✗ Failed to load WASM: ' + e.message;
                document.getElementById('info').textContent = 'Error: ' + e.stack;
            }
        }

        function runValidate() {
            if (!wasmReady) return;
            const config = document.getElementById('config').value;
            try {
                const result = validate(config);
                const el = document.getElementById('validate-result');
                el.textContent = JSON.stringify(result, null, 2);
                el.className = result.valid ? 'success' : 'error';
            } catch (e) {
                document.getElementById('validate-result').textContent = 'Error: ' + e.message;
                document.getElementById('validate-result').className = 'error';
            }
        }

        function runSimulate() {
            if (!wasmReady) return;
            const config = document.getElementById('config').value;
            const method = document.getElementById('method').value;
            const host = document.getElementById('host').value;
            const path = document.getElementById('path').value;

            const request = create_sample_request(method, host, path);

            try {
                const result = simulate(config, JSON.stringify(request));
                document.getElementById('simulate-result').textContent = JSON.stringify(result, null, 2);
                document.getElementById('simulate-result').className = result.matched_route ? 'success' : '';
            } catch (e) {
                document.getElementById('simulate-result').textContent = 'Error: ' + e.message;
                document.getElementById('simulate-result').className = 'error';
            }
        }

        function runSimulateNoMatch() {
            if (!wasmReady) return;
            const config = document.getElementById('config').value;
            const request = create_sample_request('GET', 'example.com', '/unknown/path');

            try {
                const result = simulate(config, JSON.stringify(request));
                document.getElementById('simulate-result').textContent = JSON.stringify(result, null, 2);
            } catch (e) {
                document.getElementById('simulate-result').textContent = 'Error: ' + e.message;
                document.getElementById('simulate-result').className = 'error';
            }
        }

        function runNormalized() {
            if (!wasmReady) return;
            const config = document.getElementById('config').value;
            try {
                const result = get_normalized_config(config);
                document.getElementById('normalized-result').textContent = JSON.stringify(result, null, 2);
            } catch (e) {
                document.getElementById('normalized-result').textContent = 'Error: ' + e.message;
                document.getElementById('normalized-result').className = 'error';
            }
        }

        let currentTopologyTab = 'text';

        function switchTopologyTab(format, btn) {
            if (!wasmReady) return;
            currentTopologyTab = format;

            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');

            const config = document.getElementById('config').value;
            const el = document.getElementById('topology-result');
            const mermaidContainer = document.getElementById('mermaid-container');

            // Toggle mermaid visual container vs text pre
            if (format === 'mermaid') {
                mermaidContainer.style.display = 'block';
                el.style.display = 'none';
            } else {
                mermaidContainer.style.display = 'none';
                el.style.display = 'block';
            }

            try {
                if (format === 'graph') {
                    const result = inspect_topology(config);
                    if (result.error) {
                        el.textContent = `Error: ${result.error}\n${result.details.join('\n')}`;
                        el.className = 'error';
                    } else {
                        el.textContent = JSON.stringify(result, null, 2);
                        el.className = '';
                    }
                } else if (format === 'mermaid') {
                    const result = render_topology(config, format);
                    if (result.error) {
                        mermaidContainer.style.display = 'none';
                        el.style.display = 'block';
                        el.textContent = `Error: ${result.error}\n${result.details.join('\n')}`;
                        el.className = 'error';
                    } else {
                        document.getElementById('mermaid-source').textContent = result.output;
                        renderMermaidDiagram(result.output);
                    }
                } else {
                    const result = render_topology(config, format);
                    if (result.error) {
                        el.textContent = `Error: ${result.error}\n${result.details.join('\n')}`;
                        el.className = 'error';
                    } else {
                        el.textContent = result.output;
                        el.className = '';
                    }
                }
            } catch (e) {
                mermaidContainer.style.display = 'none';
                el.style.display = 'block';
                el.textContent = 'Error: ' + e.message;
                el.className = 'error';
            }
        }

        function runLint() {
            if (!wasmReady) return;
            document.getElementById('mermaid-container').style.display = 'none';
            const el = document.getElementById('topology-result');
            el.style.display = 'block';
            // Deactivate all tabs since lint is a separate action
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const config = document.getElementById('config').value;

            try {
                const result = lint_config(config);
                if (result.error) {
                    el.textContent = `Error: ${result.error}\n${result.details.join('\n')}`;
                    el.className = 'error';
                    return;
                }
                if (result.warnings.length === 0) {
                    el.innerHTML = '<span class="success">No warnings found.</span>';
                    return;
                }
                const lines = result.warnings.map(w => {
                    const icon = w.severity === 'Error' ? 'x' : w.severity === 'Warn' ? '!' : 'i';
                    return `[${icon}] ${w.code}: ${w.message}`;
                });
                const summary = result.has_errors
                    ? `<span class="err-badge">${result.warnings.length} warning(s), has errors</span>`
                    : `<span class="warn-badge">${result.warnings.length} warning(s)</span>`;
                el.innerHTML = summary + '\n\n' + lines.join('\n');
            } catch (e) {
                el.textContent = 'Error: ' + e.message;
                el.className = 'error';
            }
        }

        initWasm();
    </script>
</body>
</html>
