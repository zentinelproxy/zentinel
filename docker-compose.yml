version: '3.8'

services:
  # Main proxy service
  proxy:
    build:
      context: .
      target: proxy
    container_name: sentinel-proxy
    ports:
      - "8080:8080"   # HTTP
      - "8443:8443"   # HTTPS
      - "9090:9090"   # Health/Metrics
    volumes:
      - ./config/docker/proxy.kdl:/etc/sentinel/config.kdl:ro
      - proxy-data:/var/lib/sentinel
      - proxy-logs:/var/log/sentinel
      - agent-sockets:/var/run/sentinel
    environment:
      RUST_LOG: info,sentinel_proxy=debug
      SENTINEL_CONFIG: /etc/sentinel/config.kdl
    networks:
      - sentinel
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Echo agent (reference implementation for testing)
  echo:
    build:
      context: .
      target: echo-agent
    container_name: sentinel-echo
    volumes:
      - agent-sockets:/var/run/sentinel
    environment:
      RUST_LOG: info,sentinel_echo_agent=debug
    networks:
      - sentinel
    restart: unless-stopped

  # Test backend service
  backend:
    image: kennethreitz/httpbin:latest
    container_name: sentinel-backend
    networks:
      - sentinel
    ports:
      - "8081:80"
    environment:
      GUNICORN_CMD_ARGS: "--workers=4"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/status/200"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: sentinel-prometheus
    volumes:
      - ./config/docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - sentinel
    ports:
      - "9091:9090"
    restart: unless-stopped

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: sentinel-grafana
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: sentinel
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel
      GF_USERS_ALLOW_SIGN_UP: false
    networks:
      - sentinel
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    restart: unless-stopped

  # Jaeger for distributed tracing (optional)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: sentinel-jaeger
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: :9411
      COLLECTOR_OTLP_ENABLED: true
    networks:
      - sentinel
    ports:
      - "5775:5775/udp"  # Zipkin compact thrift
      - "6831:6831/udp"  # Jaeger compact thrift
      - "6832:6832/udp"  # Jaeger binary thrift
      - "5778:5778"      # Configs
      - "16686:16686"    # Web UI
      - "14268:14268"    # Jaeger collector
      - "14250:14250"    # gRPC
      - "9411:9411"      # Zipkin
      - "4317:4317"      # OTLP gRPC
      - "4318:4318"      # OTLP HTTP
    restart: unless-stopped

  # Development container with proxy + echo agent
  dev:
    build:
      context: .
      target: dev
    container_name: sentinel-dev
    profiles: ["dev"]  # Only run with --profile=dev
    ports:
      - "18080:8080"   # HTTP
      - "18443:8443"   # HTTPS
      - "19090:9090"   # Health/Metrics
    volumes:
      - ./config:/etc/sentinel/config-examples:ro
      - dev-data:/var/lib/sentinel
      - dev-logs:/var/log/sentinel
    environment:
      RUST_LOG: debug
    networks:
      - sentinel
    restart: unless-stopped

volumes:
  proxy-data:
    driver: local
  proxy-logs:
    driver: local
  agent-sockets:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  dev-data:
    driver: local
  dev-logs:
    driver: local

networks:
  sentinel:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# NOTE: Additional agents (ratelimit, waf, denylist, etc.) are available as
# separate repositories. See https://github.com/raskell-io for community agents
# or create your own using the agent template:
#   cargo generate --git https://github.com/raskell-io/sentinel --path agent-template
